# System performance tuning via sysctl
# File: /etc/sysctl.d/99-sysctl-performance.conf
# Reference: https://wiki.archlinux.org/title/Improving_performance

# ===== Memory Management =====

# vm.swappiness is already set to 10 in 99-swappiness.conf
# Keeping it low reduces swap usage, good for systems with sufficient RAM

# Increase cache pressure to reclaim dentries and inodes more aggressively
# Default: 100, Higher values = more aggressive reclamation
vm.vfs_cache_pressure = 50

# Dirty ratio configuration for better write performance
# Percentage of system memory that can be filled with dirty pages before forcing writes
vm.dirty_ratio = 10

# Start background writeback of dirty pages at this percentage
vm.dirty_background_ratio = 5

# OOM killer score adjustment for better OOM handling
# vm.oom_kill_allocating_task = 0  # Let OOM killer choose the best victim

# ===== Network Performance =====

# TCP Fast Open - reduces latency for subsequent connections
net.ipv4.tcp_fastopen = 3

# Increase TCP buffer sizes for better throughput
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# Increase the maximum number of packets queued on the INPUT side
net.core.netdev_max_backlog = 5000

# Enable TCP window scaling for high-bandwidth connections
net.ipv4.tcp_window_scaling = 1

# Use BBR congestion control (requires kernel 4.9+)
# BBR improves throughput and reduces latency
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# ===== File System =====

# Increase file handles limit
fs.file-max = 2097152

# Increase inotify limits (useful for IDEs, file sync tools like Syncthing)
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 512

# ===== Kernel =====

# Enable Magic SysRq key for emergency system recovery
kernel.sysrq = 1

# Reduce kernel log level to avoid performance impact
# kernel.printk = 3 3 3 3

# ===== Security (with performance consideration) =====

# Keep ASLR enabled (security) - no performance impact
# kernel.randomize_va_space = 2

# Disable unused protocols to reduce attack surface
# net.ipv6.conf.all.disable_ipv6 = 1  # Only if IPv6 not needed
