#!/bin/bash -ue

info() { printf "\n%s %s\n\n" "$(date)" "$*" >&1; }

backup() {
  : "${BORG:=borg}"
  : "${PASS:=${BORG_PASSPHRASE_HOME:=}}"
  local uri="${BORG_REPO_HOME}"

  if [[ -n "$PASS" ]]; then
    export BORG_PASSPHRASE="$PASS"
  else
    unset BORG_PASSPHRASE
  fi

  local prunning="--keep-within 2d --keep-daily 5 --keep-weekly 3 --keep-monthly 3 --keep-yearly 1"
  local name=t14s_home
  local date
  date=$(date "+%F-%T")
  # local dir="$HOME"  # Unused

  if [[ $(pidof timeshift | wc -w) == 0 ]]; then
    info "Starting backup with $BORG to $uri"
    $BORG create \
      --lock-wait 5 \
      --verbose \
      --filter AME \
      --list \
      --stats \
      --show-rc \
      --compression lz4 \
      --exclude-caches \
      --exclude "$HOME/.cache/" \
      --exclude "$HOME/.BitwigStudio/cache/" \
      --exclude "$HOME/.kube/cache/" \
      --exclude "$HOME/.config/discord/**" \
      --exclude "$HOME/.mozilla/**/**/storage" \
      --exclude "$HOME/.config/protonmail/bridge/cache/" \
      --exclude "$HOME/.local/share/protonmail/bridge-v3/gluon/backend/**" \
      --exclude "$HOME/.config/Code/" \
      --exclude "$HOME/.var/app/org.signal.Signal/cache/" \
      --exclude "$HOME/.var/app/org.mozilla.Thunderbird/" \
      --exclude "$HOME/.var/app/org.mozilla.firefox/cache/**" \
      --exclude "$HOME/.var/app/*/cache/" \
      "$uri::$name-$date" \
      "$HOME"
    info "Pruning repository"
    $BORG prune \
      --list \
      --glob-archives "$name-" \
      --show-rc \
      "$prunning" \
      "$uri"
  else
    info "Timeshift is running or is about to run, exiting..."
    exit 1
  fi
}

# Set these environment variables before running:
# export BORG_PASSPHRASE='your-passphrase'
# export BORG_REPO='user@host:repo'

if [ -z "$BORG_REPO_HOME" ] || [ -z "$BORG_PASSPHRASE_HOME" ]; then
  echo "Error: BORG_REPO_HOME and BORG_PASSPHRASE_HOME must be set"
  echo "Run: export BORG_REPO_HOME='user@host:repo'"
  echo "Run: export BORG_PASSPHRASE_HOME='your-passphrase'"
  exit 1
fi

backup
