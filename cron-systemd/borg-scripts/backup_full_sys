#!/bin/bash -ue

info() { printf "\n%s %s\n\n" "$(date)" "$*" >&1; }

backup() {
  : ${BORG:=borg}
  : ${PASS:=}
  local uri="$1"

  if [ -n "$PASS" ]; then
    export BORG_PASSPHRASE="$PASS"
  else
    unset BORG_PASSPHRASE
  fi

  local prunning="--keep-within 2d --keep-daily 1 --keep-weekly 1 --keep-monthly 3 --keep-yearly 1"
  local name=t14s_full_sys_clone
  local date=$(date "+%F-%T")

  info "Starting backup with $BORG to $uri"
  $BORG create \
    --lock-wait 5 \
    --verbose \
    --filter AME \
    --list \
    --stats \
    --show-rc \
    --compression lz4 \
    --exclude-caches \
    "$uri"::"$name-$date" \
    "$BACKUP_DRIVE"/**
  info "Pruning repository"
  $BORG prune \
    --list \
    --glob-archives "$name-" \
    --show-rc \
    $prunning \
    "$uri"
}
# Set these environment variables before running:
# export BORG_PASSPHRASE='your-passphrase'
# export BORG_REPO_FULL='user@host:repo'
# export BACKUP_DRIVE='/media/ianfundere/backup_t7'  # or wherever your backup drive is mounted

if [ -z "$BORG_REPO_FULL" ] || [ -z "$BORG_PASSPHRASE" ] || [ -z "$BACKUP_DRIVE" ]; then
  echo "Error: BORG_REPO_FULL, BORG_PASSPHRASE, and BACKUP_DRIVE must be set"
  echo "Run: export BORG_REPO_FULL='user@host:repo'"
  echo "Run: export BORG_PASSPHRASE='your-passphrase'"
  echo "Run: export BACKUP_DRIVE='/media/$USER/backup_t7'"
  exit 1
fi

backup "$BORG_REPO_FULL"
